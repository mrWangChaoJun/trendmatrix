import{y as M,d as $,o as U,c as l,a as t,z as b,t as d,e as f,F as x,r as _,m as V,p as j,w as B,A as z,b as w,g as v,q as N,B as A,j as c,n as E,_ as L}from"./index-DsZW1VjG.js";import{a as g}from"./api.service-DdFFA3tw.js";import{u as D}from"./payment.store-DgALpniH.js";import"./local-db.service-WB126Blj.js";class F{async getSubscriptionPlans(){return g.get("/commerce/subscriptions/plans")}async getUserSubscriptions(){return g.get("/commerce/subscriptions")}async getCurrentSubscription(){try{return(await this.getUserSubscriptions()).find(e=>e.status==="active")||null}catch(r){return console.error("获取当前订阅失败:",r),null}}async createSubscription(r){return g.post("/commerce/subscriptions",r)}async updateSubscription(r,e){return g.put(`/commerce/subscriptions/${r}`,e)}async cancelSubscription(r){return g.delete(`/commerce/subscriptions/${r}`)}async getSubscriptionUsage(r){return g.get(`/commerce/subscriptions/${r}/usage`)}}const p=new F,I=M("subscription",{state:()=>({plans:[],subscriptions:[],currentSubscription:null,loading:!1,error:null}),getters:{subscriptionPlans:s=>s.plans,userSubscriptions:s=>s.subscriptions,activeSubscription:s=>s.currentSubscription,isLoading:s=>s.loading,hasError:s=>!!s.error,errorMessage:s=>s.error,hasActiveSubscription:s=>!!s.currentSubscription&&s.currentSubscription.status==="active"},actions:{async fetchSubscriptionPlans(){var s,r;this.loading=!0,this.error=null;try{return this.plans=await p.getSubscriptionPlans(),this.plans}catch(e){throw this.error=((r=(s=e.response)==null?void 0:s.data)==null?void 0:r.detail)||"获取订阅计划失败",e}finally{this.loading=!1}},async fetchUserSubscriptions(){var s,r;this.loading=!0,this.error=null;try{return this.subscriptions=await p.getUserSubscriptions(),this.currentSubscription=this.subscriptions.find(e=>e.status==="active")||null,this.subscriptions}catch(e){throw this.error=((r=(s=e.response)==null?void 0:s.data)==null?void 0:r.detail)||"获取用户订阅失败",e}finally{this.loading=!1}},async fetchCurrentSubscription(){var s,r;this.loading=!0,this.error=null;try{return this.currentSubscription=await p.getCurrentSubscription(),this.currentSubscription}catch(e){throw this.error=((r=(s=e.response)==null?void 0:s.data)==null?void 0:r.detail)||"获取当前订阅失败",e}finally{this.loading=!1}},async createSubscription(s){var r,e;this.loading=!0,this.error=null;try{const a=await p.createSubscription(s);return this.subscriptions.push(a),this.currentSubscription=a,a}catch(a){throw this.error=((e=(r=a.response)==null?void 0:r.data)==null?void 0:e.detail)||"创建订阅失败",a}finally{this.loading=!1}},async updateSubscription(s,r){var e,a;this.loading=!0,this.error=null;try{const n=await p.updateSubscription(s,r),u=this.subscriptions.findIndex(h=>h.id===s);return u!==-1&&(this.subscriptions[u]=n,n.status==="active"&&(this.currentSubscription=n)),n}catch(n){throw this.error=((a=(e=n.response)==null?void 0:e.data)==null?void 0:a.detail)||"更新订阅失败",n}finally{this.loading=!1}},async cancelSubscription(s){var r,e,a;this.loading=!0,this.error=null;try{await p.cancelSubscription(s);const n=this.subscriptions.findIndex(u=>u.id===s);n!==-1&&(this.subscriptions[n].status="cancelled",((r=this.currentSubscription)==null?void 0:r.id)===s&&(this.currentSubscription=null))}catch(n){throw this.error=((a=(e=n.response)==null?void 0:e.data)==null?void 0:a.detail)||"取消订阅失败",n}finally{this.loading=!1}},async getSubscriptionUsage(s){var r,e;this.loading=!0,this.error=null;try{return await p.getSubscriptionUsage(s)}catch(a){throw this.error=((e=(r=a.response)==null?void 0:r.data)==null?void 0:e.detail)||"获取订阅使用统计失败",a}finally{this.loading=!1}},clearError(){this.error=null},reset(){this.plans=[],this.subscriptions=[],this.currentSubscription=null,this.error=null}}}),R={class:"container mx-auto px-4 py-8"},T={key:0,class:"mb-6 p-4 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 rounded-md"},q={key:1,class:"flex justify-center items-center py-16"},G={key:2,class:"grid grid-cols-1 md:grid-cols-3 gap-6"},H={class:"p-6"},J={class:"text-center mb-6"},K={class:"text-xl font-bold text-gray-900 dark:text-white"},O={class:"mt-2 text-gray-600 dark:text-gray-400"},Q={class:"mt-4"},W={class:"text-3xl font-bold text-gray-900 dark:text-white"},X={class:"text-gray-600 dark:text-gray-400"},Y={class:"mb-6"},Z={class:"space-y-2"},tt={class:"text-gray-600 dark:text-gray-400"},et={class:"mb-6"},st={class:"space-y-2"},rt={class:"flex justify-between items-center"},it={class:"font-medium text-gray-900 dark:text-white"},ot={class:"flex justify-between items-center"},nt={class:"font-medium text-gray-900 dark:text-white"},at=["onClick","disabled"],lt={key:3,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},dt={class:"bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6"},ct={class:"text-center mb-6"},ut={class:"mt-2 text-gray-600 dark:text-gray-400"},bt={class:"mt-4"},pt={class:"text-2xl font-bold text-gray-900 dark:text-white"},gt={class:"text-gray-600 dark:text-gray-400"},ht={class:"mb-6"},yt={key:0},mt=["onClick"],ft={class:"flex items-center"},xt=["id","checked","onChange"],_t=["for"],vt={key:0,class:"ml-auto"},wt={key:1,class:"text-center py-4"},kt={class:"flex items-center mb-6"},St={class:"flex space-x-4"},Ct=["disabled"],Pt={key:0,class:"animate-spin -ml-1 mr-2 h-4 w-4 border-2 border-white border-t-transparent rounded-full"},Mt=$({__name:"SubscriptionPlansView",setup(s){const r=A(),e=I(),a=D(),n=v(null),u=v(""),h=v(!0);U(async()=>{await e.fetchSubscriptionPlans(),await a.fetchPaymentMethods(),a.defaultPaymentMethod&&(u.value=a.defaultPaymentMethod.id)});const k=y=>{n.value=y},S=async()=>{if(!(!n.value||!u.value))try{await e.createSubscription({plan_id:n.value.id,payment_method_id:u.value,auto_renew:h.value}),r.push("/subscription/my")}catch(y){console.error("订阅失败:",y)}};return(y,i)=>{const C=N("router-link");return c(),l("div",R,[i[14]||(i[14]=t("div",{class:"mb-8"},[t("h1",{class:"text-2xl font-bold text-primary dark:text-white"},"TrendMatrix"),t("p",{class:"mt-2 text-gray-600 dark:text-gray-400"},"选择适合您需求的订阅计划")],-1)),b(e).error?(c(),l("div",T,d(b(e).error),1)):f("",!0),b(e).loading?(c(),l("div",q,[...i[2]||(i[2]=[t("div",{class:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"},null,-1)])])):(c(),l("div",G,[(c(!0),l(x,null,_(b(e).subscriptionPlans,o=>(c(),l("div",{key:o.id,class:"bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-shadow"},[t("div",H,[t("div",J,[t("h3",K,d(o.name),1),t("p",O,d(o.description),1),t("div",Q,[t("span",W,d(o.price),1),t("span",X,d(o.currency)+"/"+d(o.billing_cycle),1)])]),t("div",Y,[i[4]||(i[4]=t("h4",{class:"text-sm font-medium text-gray-900 dark:text-white mb-3"},"包含功能",-1)),t("ul",Z,[(c(!0),l(x,null,_(o.features,(m,P)=>(c(),l("li",{key:P,class:"flex items-start"},[i[3]||(i[3]=t("svg",{class:"h-5 w-5 text-green-500 mr-2 mt-0.5",fill:"currentColor",viewBox:"0 0 20 20"},[t("path",{"fill-rule":"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z","clip-rule":"evenodd"})],-1)),t("span",tt,d(m),1)]))),128))])]),t("div",et,[i[7]||(i[7]=t("h4",{class:"text-sm font-medium text-gray-900 dark:text-white mb-3"},"使用限制",-1)),t("div",st,[t("div",rt,[i[5]||(i[5]=t("span",{class:"text-gray-600 dark:text-gray-400"},"API 调用限制",-1)),t("span",it,d(o.api_rate_limit)+" 次/分钟",1)]),t("div",ot,[i[6]||(i[6]=t("span",{class:"text-gray-600 dark:text-gray-400"},"信号生成限制",-1)),t("span",nt,d(o.signal_limit)+" 个/月",1)])])]),t("button",{onClick:m=>k(o),disabled:b(e).loading,class:"w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"}," 选择计划 ",8,at)])]))),128))])),n.value?(c(),l("div",lt,[t("div",dt,[t("div",ct,[i[8]||(i[8]=t("h3",{class:"text-xl font-bold text-gray-900 dark:text-white"},"确认订阅",-1)),t("p",ut,"您选择了 "+d(n.value.name)+" 计划",1),t("div",bt,[t("span",pt,d(n.value.price),1),t("span",gt,d(n.value.currency)+"/"+d(n.value.billing_cycle),1)])]),t("div",ht,[i[12]||(i[12]=t("h4",{class:"text-sm font-medium text-gray-900 dark:text-white mb-3"},"支付方式",-1)),b(a).userPaymentMethods.length>0?(c(),l("div",yt,[(c(!0),l(x,null,_(b(a).userPaymentMethods,o=>(c(),l("div",{key:o.id,class:E(["flex items-center p-3 border border-gray-200 dark:border-gray-700 rounded-md mb-2 cursor-pointer",{"border-blue-500 bg-blue-50 dark:bg-blue-900/30":u.value===o.id}]),onClick:m=>u.value=o.id},[t("div",ft,[t("input",{type:"radio",id:`payment-${o.id}`,name:"payment-method",checked:u.value===o.id,onChange:m=>u.value=o.id,class:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"},null,40,xt),t("label",{for:`payment-${o.id}`,class:"ml-2 block text-sm text-gray-900 dark:text-gray-300"},d(o.type==="credit_card"?`${o.brand} ****${o.last_four}`:o.type),9,_t)]),o.is_default?(c(),l("div",vt,[...i[9]||(i[9]=[t("span",{class:"text-xs font-medium text-blue-600 dark:text-blue-400 bg-blue-100 dark:bg-blue-900/50 px-2 py-0.5 rounded"},"默认",-1)])])):f("",!0)],10,mt))),128))])):(c(),l("div",wt,[i[11]||(i[11]=t("p",{class:"text-gray-600 dark:text-gray-400 mb-4"},"您还没有添加支付方式",-1)),V(C,{to:"/payment/methods",class:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"},{default:j(()=>[...i[10]||(i[10]=[w(" 添加支付方式 ",-1)])]),_:1})]))]),t("div",kt,[B(t("input",{type:"checkbox",id:"auto-renew","onUpdate:modelValue":i[0]||(i[0]=o=>h.value=o),class:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"},null,512),[[z,h.value]]),i[13]||(i[13]=t("label",{for:"auto-renew",class:"ml-2 block text-sm text-gray-900 dark:text-gray-300"}," 自动续费 ",-1))]),t("div",St,[t("button",{onClick:i[1]||(i[1]=o=>n.value=null),class:"flex-1 py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"}," 取消 "),t("button",{onClick:S,disabled:b(e).loading||!u.value,class:"flex-1 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"},[b(e).loading?(c(),l("span",Pt)):f("",!0),w(" "+d(b(e).loading?"处理中...":"确认订阅"),1)],8,Ct)])])])):f("",!0)])}}}),Bt=L(Mt,[["__scopeId","data-v-498c76f5"]]);export{Bt as default};
//# sourceMappingURL=SubscriptionPlansView-CFaJU9Og.js.map
